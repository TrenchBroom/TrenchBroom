# Run this workflow every time a new commit pushed to your repository
on: push

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  test-and-package:
    # Name the Job
    name: Test and package
    # Set the type of machine to run on
    runs-on: ${{ matrix.os }}
    strategy:
      # Don't cancel the macOS build if the Linux build fails, etc.
      fail-fast: false
      matrix:
        os: [ubuntu-16.04, macos-10.15]
        tbdebug: [false]
        # Placeholder value since we can't have an empty array here
        gcc-package: ['']        
        exclude:
          - os: ubuntu-16.04
            gcc-package: ['']
        include:
          - os: ubuntu-16.04
            gcc-package: g++-7
          - os: ubuntu-16.04
            gcc-package: g++-8
          - os: macos-10.15
            tbdebug: true

    steps:
      # See: https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Install Linux dependencies
        if: ${{ matrix.os == 'ubuntu-16.04' }}
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test
          sudo add-apt-repository ppa:beineri/opt-qt595-xenial
          sudo apt update
          sudo apt install ${{ matrix.gcc-package }} qt59base qt59svg freeglut3-dev libglew-dev mesa-common-dev build-essential libglm-dev libxxf86vm-dev libfreeimage-dev pandoc cmake p7zip-full ninja-build xvfb rpm

      - name: Linux build (GCC8)
        if: ${{ matrix.os == 'ubuntu-16.04' && matrix.gcc-package == 'g++-8' }}
        run: ./travis-linux.sh
        env:
          TB_GCC8: 'true'

      - name: Linux build (GCC7)
        if: ${{ matrix.os == 'ubuntu-16.04' && matrix.gcc-package == 'g++-7' }}
        run: ./travis-linux.sh

      - name: macOS build
        if: ${{ matrix.os == 'macos-10.15' }}
        run: ./travis-macos.sh
        env:
          TB_DEBUG_BUILD: ${{ matrix.tbdebug }}

      - uses: actions/upload-artifact@v2
        with:
          name: my-artifact # FIXME: uploads may collide between matrix entries
          path: |
            build/*.deb
            build/*.rpm
            build/*.dmg
            build/*.md5
