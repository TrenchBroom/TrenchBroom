name: CI Builds
on:
  # Run on pushes to tags, the "master" branch, and PR's
  push:
    tags:
      - '**'
    branches:
      - master
  pull_request:

permissions:
  # This grants the GITHUB_TOKEN the necessary permissions for use with nuget.
  packages: write
  # Grant the Release step the necessary permissions to upload a release
  contents: write

env:
  # Record pull request head commit SHA
  TB_PULL_REQUEST_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
  # Set up environment variables required for caching vcpkg packages using NuGet
  # See https://learn.microsoft.com/en-us/vcpkg/consume/binary-caching-github-packages?pivots=windows-runner
  USERNAME: TrenchBroom
  VCPKG_EXE: ${{ github.workspace }}/vcpkg/vcpkg
  FEED_URL: https://nuget.pkg.github.com/TrenchBroom/index.json
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/TrenchBroom/index.json,readwrite"

jobs:
  ci-linux:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04

    steps:
      - name: Linux - Install dependencies
        run: |
          apt update -y
          apt install -y software-properties-common ca-certificates gnupg
          add-apt-repository -y ppa:ubuntu-toolchain-r/test
          apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
          add-apt-repository -y "deb https://download.mono-project.com/repo/ubuntu stable-focal main"
          apt update -y
          # Install gcc-13 runtime libraries first
          apt install -y --no-install-recommends \
            libasan8 \
            libatomic1 \
            libcc1-0 \
            libgcc-s1 \
            libgomp1 \
            libitm1 \
            liblsan0 \
            libquadmath0 \
            libtsan2 \
            libubsan1
          # Then install gcc-13 and development libraries
          apt install -y --no-install-recommends \
            g++-13 \
            gcc-13 \
            libgcc-13-dev \
            libstdc++-13-dev
          # Finally install remaining build dependencies
          apt install -y --no-install-recommends \
            build-essential \
            cmake \
            freeglut3-dev \
            git \
            libassimp-dev \
            libfreeimage-dev \
            libfreetype6-dev \
            libfuse2 \
            libgl1-mesa-dev \
            libglew-dev \
            libglu1-mesa-dev \
            libglm-dev \
            libxi-dev \
            libxrandr-dev \
            libxxf86vm-dev \
            libtinyxml2-dev \
            mesa-common-dev \
            mono-complete \
            ninja-build \
            p7zip-full \
            pandoc \
            xvfb

      # See: https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      # Install Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.9.*'

      # Linux
      - name: Linux - Bootstrap vcpkg
        shell: bash
        run: ${{ github.workspace }}/vcpkg/bootstrap-vcpkg.sh

      - name: Linux - Add NuGet sources
        shell: bash
        run: |
          mono `${{ env.VCPKG_EXE }} fetch nuget | tail -n 1` \
            sources add \
            -Source "${{ env.FEED_URL }}" \
            -StorePasswordInClearText \
            -Name GitHubPackages \
            -UserName "${{ env.USERNAME }}" \
            -Password "${{ secrets.GITHUB_TOKEN }}"
          mono `${{ env.VCPKG_EXE }} fetch nuget | tail -n 1` \
            setapikey "${{ secrets.GITHUB_TOKEN }}" \
            -Source "${{ env.FEED_URL }}"

      - name: Linux - Set compiler version
        run: |
          echo "CC=gcc-13" >> $GITHUB_ENV
          echo "CXX=g++-13" >> $GITHUB_ENV

      - name: Linux - Build
        run: |
          ./CI-linux.sh

      - name: Linux - Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-22.04
          path: |
            cmakebuild/*.zip
            cmakebuild/*.md5

      - name: Release
        uses: softprops/action-gh-release@v1
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        with:
          draft: true
          files: |
            cmakebuild/*.zip
            cmakebuild/*.zip.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload compiled manual
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        with:
          # I've created a SSH key pair following https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-create-ssh-deploy-key
          # The TrenchBroom/TrenchBroom repo has a repository secret ACTIONS_DEPLOY_KEY set to the SSH private key
          # The TrenchBroom/manual repo has a deploy key set to the SSH public key
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          external_repository: TrenchBroom/manual # Repo to deploy to
          publish_branch: gh-pages # Branch to deploy to
          publish_dir: ./cmakebuild/app/gen-manual # Source directory tree
          destination_dir: latest # Deploy to this directory in target repo
